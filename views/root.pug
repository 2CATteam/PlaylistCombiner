doctype html
html
	head
		title Spotify Guessing Game 
		meta(charset="utf-8")
		meta(name="description" content="A game where you guess who listens to what Spotify songs")
		meta(name="viewport" content="width=device-width, initial-scale=1.0")
		link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous")
		link(rel="stylesheet", type="text/css" href="/styles.css")
	body 
		.d-flex.justify-content-center.bg-success.p-5.min-vh-100
			.d-flex.w-100.justify-content-center.align-items-center.p-5#wrapContainer.bg-light.rounded-5
				.d-flex.flex-column.root-half
					h1.text-wrap Spotify Guessing Game! 
					p.text-wrap Play with your friends and stuff! Guess who's listening to what songs! 
					p.text-wrap Can play with up to a million people! 
					p.text-wrap Can use your most-listened or a custom playlist! 
					p.text-wrap Generate the fun quiz! 
					p.text-wrap Play separate or together!
					p.text-wrap Even more text! 
				.vr.m-5.landscapeOnly
				hr.m-5.w-100.portraitOnly
				.d-flex.flex-column.root-half
					h3.text-wrap Get started now! 
					.mb-3 
						label.form-label(for="sessionName") Session Name 
						input#sessionName.form-control(type="text", name="sessionName")
					.mb-3 
						label.form-label(for="songCount") Songs per Person
						select#songCount.form-select
							option(value="3") 3
							option(value="5") 5
							option(value="10") 10
							option(value="20") 20
					.mb-3 
						label.form-label(for="songMode") How should songs be selected?
						select#songMode.form-select(onchange="modeChanged()")
							each key in Object.keys(session_modes)
								option(value=session_modes[key])= session_names[key]
					.mb-3.ps-5#topSongsSelectDiv.d-none
						label.form-label(for="topSongsTimeRange") Time range for top songs:
						select#topSongsTimeRange.form-select
							option(value="short_term") Short Term (~4 weeks)
							option(value="medium_term") Medium Term (~6 months)
							option(value="long_term") Long Term (1+ years)
					.mb-3 
						input#dedupe(type="checkbox", name="dedupe", selected)
						label.ps-2.form-label(for="dedupe", checked) Limit one song per artist per person (Recommended)
					button.btn.btn-primary(type="button", onclick="createSession()") Create session 
					p.form-text.text-wrap You will be redirected to a page for your session. Once you get there, share the page with your friends to invite them!
		script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous") 
		script. 
			const TOP_SONGS_MODE = 1

			function getRequest(url, callback) {
				let submitReq = new XMLHttpRequest()
				submitReq.addEventListener("load", callback);
				submitReq.open("GET", url)
				submitReq.send()
			}

			function postRequest(url, body, callback) {
				let submitReq = new XMLHttpRequest();
				submitReq.addEventListener("load", callback);
				submitReq.open("POST", url);
				submitReq.setRequestHeader("Content-type", "application/json");
				submitReq.send(JSON.stringify(body));
			}

			function createSession() {
				let name = document.querySelector("#sessionName").value
				let size = document.querySelector("#songCount").value
				let mode = parseInt(document.querySelector("#songMode").value)
				let dedupe = document.querySelector("#dedupe").checked
				let top_songs_range = ""
				if (mode == TOP_SONGS_MODE) {
					top_songs_range = document.querySelector("#topSongsTimeRange").value
				}
				postRequest(`/addSession`, {
					name: name,
					size: size,
					mode: mode,
					dedupe: dedupe,
					top_songs_range: top_songs_range
				}, function() {
					console.log(this.status)
					console.log(this.responseText)

					if (this.status != 200) {
						try {
							let error = JSON.parse(this.responseText).error
							alert(`Could not create session! Please try again later\n\n${error}`)
						} catch (e) {
							alert(`Could not create session! Please try again later`)
						}
					} else {
						let response = JSON.parse(this.responseText)
						let sessionId = response.sessionId
						window.location.href = `/${sessionId}`
					}
				})
			}

			function modeChanged() {
				let mode = parseInt(document.querySelector("#songMode").value)
				if (mode == TOP_SONGS_MODE) {
					document.querySelector("#topSongsSelectDiv").classList.remove("d-none")
				} else {
					document.querySelector("#topSongsSelectDiv").classList.add("d-none")
				}
			}